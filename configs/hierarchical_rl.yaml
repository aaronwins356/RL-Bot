# Hierarchical RL/IL Configuration
# Based on problem statement sections 1-11

# Curriculum settings (Section 4.1)
curriculum:
  stage: 0  # Current stage (0-3)
  schedule: [0.6, 0.25, 0.15]  # [drills, scrims, matches]
  
  # Promotion rules
  promotion:
    pass_rate_threshold: 0.78
    evaluation_window: 500  # drills
  
  # Gate thresholds (Section 6.1)
  gates:
    fast_aerial:
      threshold: 0.88
      contact_distance: 120  # uu
      min_speed_to_goal: 1500  # uu/s
    
    double_tap:
      threshold: 0.40
      on_target_required: true
    
    ceiling:
      threshold: 0.60
      meaningful_shot_required: true
    
    flip_reset:
      threshold: 0.35  # Clean resets
      convert: 0.20  # Immediate conversions
      four_wheel_window_ms: 20
    
    musty:
      threshold: 0.30
      min_ball_speed: 1000  # uu/s
      on_target_required: true
    
    breezi:
      threshold: 0.30
      min_ball_speed: 1000  # uu/s
      on_target_required: true

# Reward shaping (Section 5)
rewards:
  # Hit quality
  contact: 1.0
  speed_to_goal_bonus: 0.25  # When ball speed increases > 800 uu/s
  target_cone_bonus: 0.5  # When shot within 10° cone
  goal_proximity: 0.002  # Per unit toward goal
  
  # Setup fidelity
  fast_aerial_timing: 0.2
  flip_reset_contact: 0.4  # For 4-wheel contact
  
  # Style bonuses (only when flashy_ok)
  ceiling_bonus: 0.6
  musty_bonus: 0.5
  breezi_bonus: 0.5
  doubletap_bonus: 0.7
  flipreset_goal_bonus: 1.0
  
  # Costs
  boost_cost: -0.004  # Per unit boost
  whiff_cost: -0.2
  risky_flashy_cost: -0.15  # When attempting flashy at high risk
  bad_recovery_cost: -0.3  # Recovery > 1.0s
  residual_angular_vel_cost: -0.05  # Per 0.1 rad/s at landing

# Controller settings (Section 1.2, 9)
controllers:
  # Low-level controller
  llc:
    dt: 0.00833  # 120 Hz
    pid_kp: 1.5
    pid_ki: 0.0
    pid_kd: 0.3
    pid_pos_kp: 0.5
    pid_pos_ki: 0.0
    pid_pos_kd: 0.1
  
  # Fast aerial
  fast_aerial:
    inter_jump_frames: [10, 12]
    pitch_up: [0.6, 0.9]
    timeout: 1.2  # seconds
    contact_threshold: 120  # uu
  
  # Flip reset
  flip_reset:
    contact_window_ms: 20
    max_relative_velocity: 150.0  # uu/s
    timeout: 1.5
  
  # Breezi
  breezi:
    roll_freq_hz: [5, 9]
    roll_amp: [0.12, 0.25]
    min_boost: 40
    approach_angle: [20, 35]  # degrees
    timeout: 1.5
  
  # Air roll stabilizer
  air_roll:
    damping_factor: 0.1
    max_angular_vel: 5.5  # rad/s
  
  # Ceiling shot
  ceiling:
    target_speed: [1200, 1500]  # uu/s
    takeoff_angle: [30, 45]  # degrees
    setup_timeout: 3.0
    shot_timeout: 2.0
  
  # Double tap
  double_tap:
    arrival_buffer: [150, 250]  # ms
    aim_cone_deg: 8
    timeout: 2.5
  
  # Ground to air dribble
  ground_to_air_dribble:
    pop_height: [45, 80]  # uu
    carry_height: [50, 120]  # uu above hood
    timeout: 5.0
  
  # Musty
  musty:
    nose_angle: [60, 110]  # degrees
    min_boost: 30
    timeout: 1.0
  
  # Aerial control
  aerial_control:
    damping_factor: 0.2
    target_angular_vel_threshold: 0.5  # rad/s
    timeout: 3.0

# Opportunity Detector (Section 1.1)
opportunity_detector:
  model:
    obs_dim: 180
    hidden_dim: 256
    use_lstm: true  # false for transformer
  
  temperature: 1.0
  safe_option_floor: 0.2
  context_window_frames: 60  # 0.5s at 120 Hz
  
  # Risk scoring (Section 8)
  risk_scorer:
    safe_time_threshold: 45.0  # seconds
    defensive_third_y: -3000  # uu

# Training settings (Section 4)
training:
  # IL → RL pipeline
  il:
    enabled: true
    bc_epochs: 50
    bc_lr: 0.001
    bc_batch_size: 256
    dagger_iterations: 5
  
  # RL fine-tuning
  rl:
    algorithm: "ppo"  # or "sac"
    learning_rate: 0.0003
    batch_size: 4096
    n_epochs: 3
    gamma: 0.995
    gae_lambda: 0.95
    clip_range: 0.2
    ent_coef: 0.01
  
  # Data augmentation (Section 4.3)
  augmentation:
    randomize_ball_speed: true
    randomize_spawn_height: true
    randomize_wall_normal: true
    randomize_car_orientation: true
    randomize_boost_pads: true
    latency_injection_ms: [2, 6]
  
  # Self-play scheduling (Section 4.4)
  selfplay:
    drill_weight: 0.60
    scrimmage_weight: 0.25
    match_weight: 0.15

# Match KPIs (Section 6.2)
match_kpis:
  aerial_contest_win_rate_delta: 0.12  # +12% over baseline
  flashy_attempt_precision: 0.75  # Attempt only when viable
  flashy_conversion_rate: 0.25
  max_defensive_turnover_increase: 0.05  # 5%
  min_elo_delta: 50  # Over 500 games

# Feature flags (Section 11)
features:
  flashy_enabled: false  # Auto-enable after gates pass
  auto_enable_after_passes: 3  # Consecutive eval cycles

# Telemetry (Section 9)
telemetry:
  enabled: true
  log_sp_choices: true
  log_confidence: true
  log_success_timeout: true
  log_contact_metrics: true
  log_boost_spent: true
  log_recovery_time: true
  log_style_bonuses: true
  
  # Debug outputs
  generate_whiff_heatmaps: true
  generate_landing_histograms: true
  per_sp_elo_tracking: true

# Observation settings (Section 2.1)
observations:
  # Ball prediction samples
  prediction_times: [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
  
  # History
  include_last_n_controls: 20
  include_last_n_contacts: 3
  
  # Curriculum flags
  include_curriculum_flags: true

# Action space (Section 2.2)
actions:
  continuous: ['steer', 'throttle', 'yaw', 'pitch', 'roll']
  binary: ['jump', 'boost', 'handbrake']
  discrete_triggers: [
    'initiate_fast_aerial',
    'start_ceiling_setup', 
    'start_flip_reset',
    'execute_musty',
    'begin_breezi',
    'commit_double_tap'
  ]

# Network architecture (Section 1.2)
network:
  # Backbone
  backbone:
    type: "mlp_lstm"  # 3D spatial encoder → MLP → LSTM
    spatial_encoder_dim: 256
    mlp_hidden: [512, 512]
    lstm_hidden: 256
  
  # Heads
  heads:
    action:
      continuous_dim: 5  # [steer, throttle, yaw, pitch, roll]
      binary_dim: 3  # [jump, boost, handbrake]
      discrete_dim: 6  # Tech triggers
    
    value:
      enabled: true
    
    auxiliary:
      contact_timing: true  # Predict frames to ball touch
      backboard_normal: true
      wall_ride_feasibility: true
      flip_reset_window: true

# Logging
logging:
  log_dir: "logs/hierarchical"
  tensorboard: true
  save_videos: true
  video_interval: 10000  # timesteps
  checkpoint_interval: 50000

# Evaluation
evaluation:
  eval_interval: 100000  # timesteps
  num_eval_games: 50
  run_drill_gates: true
  gate_eval_interval: 200000  # timesteps
